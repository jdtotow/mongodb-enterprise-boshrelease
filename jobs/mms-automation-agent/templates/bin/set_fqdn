#!/bin/bash

set +e

<% if p('mongodb.use_consul') %>

# Set fqdn as service_id+index or bosh dns address
export fqdn="<%= "#{p("mms-automation-agent.service_id")}-#{spec.index}.service.consul" %>"

<% else

dns = p("mongodb.dns")
ips = p("mongodb.ips")

aliases = {}
# we expect dns and ips to have the same length
dns.zip(ips) do |name, ip|
  aliases[ip]=name
end

%>

export fqdn="<%= "#{aliases[spec.ip]}" %>"

<% end %>

sed -i "s/^\(127.0.0.1\)\W*\(localhost\)/\1 ${fqdn} \2/" /etc/hosts

# Check if fqdn matches what we want
if [ "$(hostname -f)" = "${fqdn}" ]; then
  echo "hostname matches: ${fqdn}"
  exit 0
else
  echo "hostname mismatch, expected ${fqdn}"
  echo "check /etc/hosts"
  exit 1
fi

set -e
